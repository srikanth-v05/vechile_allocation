<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Allocation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>
        /* Styling for the table and making it scrollable */
        #vehicle-table {
            max-height: 300px; /* Limit the height to 4 rows */
            overflow-y: scroll;
            border: 1px solid #ddd;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>

<body>

    <div class="container mt-5">
        <!-- Form to select the date for vehicle allocation -->
        <form id="allocation-form">
            <div class="form-group">
                <label for="selected_date">Select Date:</label>
                <input type="date" id="selected_date" name="selected_date" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Run Allocation</button>
        </form>

        <!-- Layout for the map and table of allocations -->
        <div class="row mt-5">
            <!-- Left column for the map -->
            <div class="col-md-8">
                <div id="map-container" style="height: 400px;">
                    <p class="text-muted">Click a vehicle number to view the map here.</p>
                </div>
            </div>

            <!-- Right column for the vehicle table -->
            <div class="col-md-4">
                <h3>Vehicle Allocations:</h3>

                <!-- Scrollable Table for vehicles -->
                <div id="vehicle-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Vehicle Number</th>
                            </tr>
                        </thead>
                        <tbody id="vehicles-list">
                            <!-- Vehicle list will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>

        function setTodayDate() {
                const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
                document.getElementById('selected_date').value = today;
            }

            // Set default date and submit the form only once
            window.onload = function() {
                // Check if the date input is already set (to avoid multiple submissions)
                const selectedDateInput = document.getElementById('selected_date');
                if (!selectedDateInput.value) { // If the input is empty (no date set)
                    selectedDateInput=setTodayDate(); // Set today's date
                    document.getElementById('allocation-form').submit(); // Submit the form once
                }
                
                
            };  
        $(document).ready(function () {
            // Handle form submission
            $('#allocation-form').on('submit', function (e) {
                e.preventDefault();

                // Fetch the selected date
                let selectedDate = $('#selected_date').val();

                // Run the allocation via AJAX
                $.ajax({
                    url: '/run_allocation',
                    method: 'POST',
                    data: { selected_date: selectedDate },
                    success: function (response) {
                        // Clear previous results
                        $('#vehicles-list').empty();

                        if (response.length === 0) {
                            $('#vehicles-list').append('<tr><td>No vehicles allocated for the selected date.</td></tr>');
                        } else {
                            // Display the vehicle allocations in the table (right side)
                            response.forEach(function (vehicle, index) {
                                let vehicleRow = `
                                    <tr class="vehicle-item" data-map-url="${vehicle.map_url}">
                                        <td>${vehicle.vehicle_id}</td>
                                    </tr>`;
                                $('#vehicles-list').append(vehicleRow);
                            });

                            // Add click handler to vehicle items in the table
                            $('.vehicle-item').on('click', function () {
                                let mapUrl = $(this).data('map-url');
                                $('#map-container').html(`<iframe src="${mapUrl}" width="100%" height="400" frameborder="0"></iframe>`);
                            });
                        }
                    },
                    error: function (error) {
                        console.error("Error running allocation:", error);
                        alert("An error occurred while running the allocation. Please try again.");
                    }
                });
            });
        });
    </script>

</body>

</html>
